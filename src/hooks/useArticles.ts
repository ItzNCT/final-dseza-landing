import { useQuery } from "@tanstack/react-query";
import { useParams } from "react-router-dom";
import { extractImageUrl, useDrupalApi } from "@/utils/drupal";
import { extractFirstImageFromRichText } from "@/utils/richTextProcessor";
import { useAllNewsCategories } from "./useNewsCategories";
import { useLanguage } from "@/context/LanguageContext";

// ƒê·ªãnh nghƒ©a c·∫•u tr√∫c cho m·ªôt b√†i vi·∫øt
export interface Article {
  id: string;
  title: string;
  summary: string;
  imageUrl?: string;
  path: string;
  published_date: string;
  categories: string[];
  is_featured?: boolean;
}

// Custom hook ƒë·ªÉ l·∫•y danh s√°ch b√†i vi·∫øt theo category
export const useArticles = () => {
  const { category, subcategory } = useParams<{ category: string; subcategory?: string; }>();
  const { data: categoriesData } = useAllNewsCategories(); // Use ALL categories instead of just event categories
  const { apiGet } = useDrupalApi(); // Use language-aware API client
  const { language } = useLanguage(); // Get current language

  const fetchArticles = async (): Promise<Article[]> => {
    // X√°c ƒë·ªãnh target category cho filter
    const targetCategory = subcategory || category;

    if (!targetCategory) {
      return []; // N·∫øu kh√¥ng c√≥ category, tr·∫£ v·ªÅ m·∫£ng r·ªóng
    }

    // X√¢y d·ª±ng API options v·ªõi JSON:API
    const apiOptions = {
      filter: {
        status: { value: '1' } // Ch·ªâ l·∫•y b√†i vi·∫øt ƒë√£ publish
      },
      sort: '-created', // S·∫Øp x·∫øp theo ng√†y t·∫°o m·ªõi nh·∫•t
      page: { limit: 20 }, // Gi·ªõi h·∫°n 20 b√†i vi·∫øt
      include: 'field_anh_dai_dien.field_media_image,field_chuyen_muc' // Include images v√† categories
    };

    // N·∫øu targetCategory l√† 'su-kien', 'events', ho·∫∑c 'tin-tuc' th√¨ l·∫•y t·∫•t c·∫£ tin t·ª©c (kh√¥ng filter)
    const showAllNews = targetCategory === 'su-kien' || targetCategory === 'tin-tuc' || targetCategory === 'events';

    // URL mapping ƒë·ªÉ convert t·ª´ URL slug sang category name th·ª±c t·∫ø
    const urlToCategoryMap: { [key: string]: string } = {
      'dau-tu-hop-tac-quoc-te': 'ƒê·∫ßu t∆∞ ‚Äì H·ª£p t√°c qu·ªëc t·∫ø',
      'dao-tao-uom-tao-khoi-nghiep': 'ƒê√†o t·∫°o, ∆Ø∆°m t·∫°o kh·ªüi nghi·ªáp',
      'chuyen-doi-so': 'Chuy·ªÉn ƒë·ªïi s·ªë',
      'hoat-dong-ban-quan-ly': 'Ho·∫°t ƒë·ªông Ban qu·∫£n l√Ω',
      'tin-khac': 'Tin kh√°c',
      'tin-tuc-khac': 'Tin kh√°c',
      'other-news': 'Tin kh√°c',
      'doanh-nghiep': 'Doanh nghi·ªáp',
      'thong-bao': 'Th√¥ng b√°o',
      'thong-tin-bao-chi': 'Th√¥ng tin b√°o ch√≠',
      'press-information': 'Th√¥ng tin b√°o ch√≠',
      'hoat-dong': 'Ho·∫°t ƒë·ªông',
      'su-kien': 'Tin t·ª©c & S·ª± ki·ªán',
      'events': 'Tin t·ª©c & S·ª± ki·ªán',
      'tin-tuc': 'Tin t·ª©c',
      // Investment-related categories
      'quy-trinh-linh-vuc-dau-tu': 'Quy tr√¨nh lƒ©nh v·ª±c ƒë·∫ßu t∆∞',
      'linh-vuc-khuyen-khich-dau-tu': 'Lƒ©nh v·ª±c thu h√∫t ƒë·∫ßu t∆∞',
      'linh-vuc-thu-hut-dau-tu': 'Lƒ©nh v·ª±c thu h√∫t ƒë·∫ßu t∆∞', // Alternative slug
      'danh-cho-nha-dau-tu': 'D√†nh cho nh√† ƒë·∫ßu t∆∞', // Parent category
      
      // Investment environment subcategories
      'moi-truong-dau-tu': 'M√¥i tr∆∞·ªùng ƒë·∫ßu t∆∞', // Parent category
      'ha-tang-giao-thong': 'H·∫° t·∫ßng giao th√¥ng',
      'khoa-hoc-cong-nghe-moi-truong': 'Khoa h·ªçc c√¥ng ngh·ªá - M√¥i tr∆∞·ªùng',
      'logistics': 'Logistics',
      'ha-tang-xa-hoi': 'H·∫° t·∫ßng x√£ h·ªôi',
      'nguon-nhan-luc': 'Ngu·ªìn nh√¢n l·ª±c',
      'cai-cach-hanh-chinh': 'C·∫£i c√°ch h√†nh ch√≠nh',
      // English slugs for Investment Environment categories mapping to Vietnamese category names
      'transportation-infrastructure': 'H·∫° t·∫ßng giao th√¥ng',
      'science-technology-environment': 'Khoa h·ªçc c√¥ng ngh·ªá - M√¥i tr∆∞·ªùng',
      'social-infrastructure': 'H·∫° t·∫ßng x√£ h·ªôi',
      'human-resources': 'Ngu·ªìn nh√¢n l·ª±c',
      'industrial-park-infrastructure': 'H·∫° t·∫ßng khu c√¥ng nghi·ªáp',
      // English slugs for Investor-related categories
      'investment-sector-procedures': 'Quy tr√¨nh lƒ©nh v·ª±c ƒë·∫ßu t∆∞',
      'investment-incentive-sectors': 'Lƒ©nh v·ª±c thu h√∫t ƒë·∫ßu t∆∞',
      'administrative-reform': 'C·∫£i c√°ch h√†nh ch√≠nh',
    };

    // L·∫•y category name t·ª´ mapping, ho·∫∑c n·∫øu kh√¥ng c√≥ trong map th√¨ t√¨m trong categoriesData
    let categoryNameToFilter = urlToCategoryMap[targetCategory];
    
    // N·∫øu kh√¥ng t√¨m th·∫•y trong hardcode map, th·ª≠ t√¨m trong real categories data
    if (!categoryNameToFilter && categoriesData) {
      const foundCategory = categoriesData.find(cat => 
        cat.name.toLowerCase().includes(targetCategory.replace(/-/g, ' ').toLowerCase()) ||
        targetCategory.replace(/-/g, ' ').toLowerCase().includes(cat.name.toLowerCase())
      );
      if (foundCategory) {
        categoryNameToFilter = foundCategory.name;
      }
    }

    if (!showAllNews && categoryNameToFilter) {
      // Debug: Log category filtering info
      console.log(`üîç Filtering articles for category: "${categoryNameToFilter}" (from slug: "${targetCategory}")`);
      // Add category filter to API options
      apiOptions.filter['field_chuyen_muc.name'] = categoryNameToFilter;
    } else if (!showAllNews) {
      console.log(`‚ö†Ô∏è No category name found for filtering. Target category: "${targetCategory}"`);
    }

    try {
      console.log(`üì° API call for category "${targetCategory}" with options:`, apiOptions);
      console.log(`üîç showAllNews: ${showAllNews}, categoryNameToFilter: "${categoryNameToFilter}"`);
      
      const data = await apiGet('/jsonapi/node/bai-viet', apiOptions);
      console.log(`üìä API returned ${data.data?.length || 0} articles for category "${targetCategory}"`);
      console.log(`üìã Raw API response:`, data);
      
      // Map d·ªØ li·ªáu tr·∫£ v·ªÅ th√†nh c·∫•u tr√∫c Article
      let articles = data.data?.map((item: any) => {
        // L·∫•y categories t·ª´ relationships
        let categories: string[] = [];
        if (item.relationships?.field_chuyen_muc?.data?.length > 0 && data.included) {
          item.relationships.field_chuyen_muc.data.forEach((categoryRelation: any) => {
            const categoryItem = data.included.find((inc: any) => 
              inc.type === 'taxonomy_term--news_category' && inc.id === categoryRelation.id
            );
            if (categoryItem) {
              categories.push(categoryItem.attributes.name);
            }
          });
        }

        // L·∫•y featured image b·∫±ng extractImageUrl
        let featuredImage = extractImageUrl(item.relationships?.field_anh_dai_dien, data.included);
        
        // N·∫øu kh√¥ng c√≥ featured image, th·ª≠ extract t·ª´ body content
        if (!featuredImage && item.attributes?.body?.processed) {
          featuredImage = extractFirstImageFromRichText(item.attributes.body.processed, data.included);
        }

        // T·∫°o path t·ª´ ID ho·∫∑c UUID
        const articlePath = `/bai-viet/${item.id}`;

        return {
          id: item.id,
          title: item.attributes.title,
          summary: item.attributes?.body?.summary || 
                   item.attributes?.body?.value?.substring(0, 200) + '...' || 
                   'Nh·∫•n ƒë·ªÉ xem chi ti·∫øt n·ªôi dung b√†i vi·∫øt...',
          imageUrl: featuredImage,
          path: articlePath,
          published_date: item.attributes.created,
          categories: categories,
          is_featured: item.attributes?.field_su_kien_tieu_bieu || false,
        };
      }) || [];
      
            // Client-side filtering fallback n·∫øu server-side filtering kh√¥ng ho·∫°t ƒë·ªông
      if (!showAllNews && articles.length > 0) {
        // Helper function to normalize text for comparison
        const normalizeText = (text: string): string => {
          return text.toLowerCase()
                     .trim()
                     .replace(/\s+/g, ' ') // normalize spaces
                     .replace(/[‚Äì‚Äî-]/g, '-') // normalize dashes
                     .replace(/[^\w\s-]/g, ''); // remove special chars except word chars, spaces, and dashes
        };

        // If we have a specific category name to filter by
        if (categoryNameToFilter) {
          const originalCount = articles.length;
          
          // Filter articles that contain the target category name in their categories array
          articles = articles.filter(article => {
            const hasMatchingCategory = article.categories.some(category => {
              const normalizedArticleCategory = normalizeText(category);
              const normalizedTargetCategory = normalizeText(categoryNameToFilter);
              
              // Multiple matching strategies
              return (
                // Exact match
                normalizedArticleCategory === normalizedTargetCategory ||
                // Contains match (both directions)
                normalizedArticleCategory.includes(normalizedTargetCategory) ||
                normalizedTargetCategory.includes(normalizedArticleCategory) ||
                // Word boundary match
                normalizedArticleCategory.split(' ').some(word => 
                  normalizedTargetCategory.split(' ').includes(word) && word.length > 2
                )
              );
            });
            
            return hasMatchingCategory;
          });
          
          console.log(`üéØ Client-side filtered: ${originalCount} ‚Üí ${articles.length} articles for "${categoryNameToFilter}"`);
          
          // Debug: Log first few articles and their categories
          if (articles.length > 0) {
            console.log(`‚úÖ Sample filtered articles:`, articles.slice(0, 3).map(a => ({
              title: a.title,
              categories: a.categories
            })));
          } else {
            console.log(`‚ùå No articles found for category "${categoryNameToFilter}"`);
          }
        } else if (targetCategory && targetCategory !== 'su-kien' && targetCategory !== 'tin-tuc') {
          // Fallback: filter by URL slug if no category name mapping found
          const originalCount = articles.length;
          const targetSlugWords = targetCategory.replace(/-/g, ' ').toLowerCase().split(' ');
          
          articles = articles.filter(article => {
            return article.categories.some(category => {
              const categoryWords = category.toLowerCase().split(' ');
              return targetSlugWords.some(slugWord => 
                categoryWords.some(catWord => catWord.includes(slugWord) && slugWord.length > 2)
              );
            });
          });
          
          console.log(`üîÑ Slug-based filtered: ${originalCount} ‚Üí ${articles.length} articles for "${targetCategory}"`);
        }
      }
       
      return articles;
    } catch (error) {
      console.error("Error fetching articles:", error);
      throw new Error("Failed to fetch articles");
    }
  };

  return useQuery<Article[], Error>({
    queryKey: ['articles', category, subcategory, language], // Include language in query key
    queryFn: fetchArticles,
    enabled: !!(category), // Ch·ªâ fetch khi c√≥ category
    staleTime: 5 * 60 * 1000, // 5 minutes
    gcTime: 10 * 60 * 1000, // 10 minutes
    retry: 3,
  });
};